# Official Render Blueprint for n8n + Postgres
# Deploy: Fork this to GitHub, then New > Blueprint on render.com
# Docs: https://render.com/docs/deploy-n8n
# Pin n8n version if needed: Change image.url to docker.n8n.io/n8nio/n8n:1.58.0 (example)

services:
  - type: web
    name: n8n  # Becomes your URL: n8n.onrender.com
    env: docker
    imageUrl: docker.n8n.io/n8nio/n8n:latest  # Clean URL - no extra slashes
    default: true
    envVars:  # Mapping (key: value) - NOT a list! This fixes unmarshal errors
      # Core n8n Config
      N8N_ENCRYPTION_KEY: ${N8N_ENCRYPTION_KEY?}  # Auto-generated by Render (32+ chars)
      N8N_BASIC_AUTH_ACTIVE: "true"
      N8N_BASIC_AUTH_USER: "admin"  # Change to your preferred username
      N8N_BASIC_AUTH_PASSWORD: ${N8N_BASIC_AUTH_PASSWORD?}  # Set in Render UI or generate
      # Database (auto-linked from below)
      DB_TYPE: postgresdb
      DB_POSTGRESDB_DATABASE: n8n
      DB_POSTGRESDB_HOST: ${DB_INTERNAL_HOST}  # Render auto-injects
      DB_POSTGRESDB_PORT: "5432"
      DB_POSTGRESDB_USER: ${DB_USER}
      DB_POSTGRESDB_PASSWORD: ${DB_PASSWORD}
      DB_POSTGRESDB_SSL_CA: ${DB_SSL_CA?}
      DB_POSTGRESDB_SSL_CERT: ${DB_SSL_CERT?}
      DB_POSTGRESDB_SSL_KEY: ${DB_SSL_KEY?}
      # Web/Port (Render handles PORT auto)
      PORT: "5678"
      N8N_PORT: "5678"
      N8N_HOST: "0.0.0.0"  # Bind to all interfaces
      WEBHOOK_URL: "https://n8n.onrender.com/"  # Update post-deploy to your actual URL
      # Node.js (fixes build errors)
      NODE_VERSION: "18.20.0"  # LTS; prevents n8n build crashes
      # Optional: Disable telemetry
      N8N_DIAGNOSTICS_ENABLED: "false"
    # Disk for persistence (optional, for .n8n folder)
    disk:
      name: n8n-data
      mountPath: /home/node/.n8n
      sizeGB: 1  # Free tier max; upgrade for more
    # Health check (helps with cron pings)
    healthCheckPath: /healthz
    healthCheckType: http
    healthCheckTimeout: 5
    healthCheckInterval: 30
    healthCheckMaxAttempts: 3
    # Free tier; upgrade to starter for always-on
    plan: free

databases:
  - name: n8n-db  # Auto-links to service via ${DB_*} vars above
    databaseName: n8n
    user: n8n-user
    plan: free  # 30-day trial; change to 'starter' post-setup
    postgres: true  # Enforces Postgres type
