# n8n on Render with Postgres (updated 2025 syntax – pulls prebuilt image)
services:
  # n8n Web Service (pulls official image – no build/Dockerfile)
  - type: web
    name: n8n
    runtime: image  # Key fix: 'image' for prebuilt Docker pulls (not 'docker' or 'env: docker')
    image: docker.n8n.io/n8nio/n8n:latest  # Official n8n image – Render pulls it
    region: oregon  # Or your preferred region (e.g., frankfurt)
    plan: free  # Upgrade to starter for always-on

    envVars:
      # Core n8n settings (auto-URL for webhooks)
      - key: N8N_HOST
        value: https://${n8n.URL}
        sync: false  # Edit manually post-deploy if needed
      - key: N8N_PORT
        value: 5678
      - key: N8N_PROTOCOL
        value: https

      # Database (auto-links to n8n-db below)
      - key: DB_TYPE
        value: postgresdb
      - key: DB_POSTGRESDB_HOST
        fromDatabase:
          name: n8n-db
          property: host
      - key: DB_POSTGRESDB_PORT
        fromDatabase:
          name: n8n-db
          property: port
      - key: DB_POSTGRESDB_DATABASE
        fromDatabase:
          name: n8n-db
          property: database
      - key: DB_POSTGRESDB_USER
        fromDatabase:
          name: n8n-db
          property: user
      - key: DB_POSTGRESDB_PASSWORD
        fromDatabase:
          name: n8n-db
          property: password

      # Security (fixed encryption prevents data loss)
      - key: N8N_ENCRYPTION_KEY
        generateValue: true  # Auto-generates persistent key
      - key: N8N_BASIC_AUTH_ACTIVE
        value: "true"
      - key: N8N_BASIC_AUTH_USER
        value: admin  # Customize
      - key: N8N_BASIC_AUTH_PASSWORD
        generateValue: true  # Auto-strong password (copy from dashboard)

      # Production & Webhooks
      - key: WEBHOOK_URL
        value: https://${n8n.URL}
      - key: NODE_ENV
        value: production

# Postgres DB (free 90-day trial)
databases:
  - name: n8n-db
    plan: free
    region: oregon  # Match service region
